{% extends "base.html" %}
{% block content %}
<div class="container" style="max-width:450px; padding: 4rem 1rem;">
  <div class="auth-card"
    style="background: var(--bg-card); padding: 2.5rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); text-align: center;">
    <h2 style="font-size: 2rem; color: var(--text-main); margin-bottom: 1rem; font-family: 'Poppins', sans-serif;">
      Mobile Login</h2>
    <p style="color: var(--text-muted); margin-bottom: 2rem;">Scan the QR code with your mobile device to log in using
      face verification.</p>

    <div class="card">
      <form id="mobile-login-form" style="display: flex; flex-direction: column; gap: 1.25rem;">
        <div class="form-group" style="text-align: left;">
          <label for="email"
            style="display: block; margin-bottom: 0.5rem; color: var(--text-main); font-weight: 500;">Email</label>
          <input type="email" id="email" name="email" required
            style="width: 100%; padding: 0.75rem; border-radius: var(--radius); border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-main);">
        </div>
        <button type="submit" class="btn-primary"
          style="width: 100%; padding: 0.85rem; border: none; border-radius: var(--radius); background: var(--primary); color: white; font-weight: 600; cursor: pointer;">Generate
          QR Code</button>
      </form>

      <div id="qr-container"
        style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color); text-align: center;">
        <h3 style="font-size: 1.25rem; color: var(--text-main); margin-bottom: 1.5rem;">Scan with your mobile device
        </h3>
        <div id="qrcode" style="display: inline-block; padding: 10px; background: white; border-radius: 8px;"></div>
        <p style="margin-top: 1.5rem; color: var(--text-muted); font-size: 0.9rem;">Your mobile device will open a page
          to capture your face for verification.</p>
        <div id="verification-status" style="margin-top: 1.5rem;"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode.js/lib/qrcode.min.js"></script>
  <script>
    document.getElementById('mobile-login-form').addEventListener('submit', async function (e) {
      e.preventDefault();

      const email = document.getElementById('email').value;

      try {
        const response = await fetch('/api/generate-verification-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email: email })
        });

        const data = await response.json();

        if (data.success) {
          // Show QR code
          document.getElementById('qr-container').style.display = 'block';

          // Generate QR code
          new QRCode(document.getElementById("qrcode"), {
            text: data.verification_url,
            width: 200,
            height: 200
          });

          // Start checking verification status
          checkVerificationStatus(data.token);
        } else {
          alert('Error: ' + data.error);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to generate verification token');
      }
    });

    function checkVerificationStatus(token) {
      const statusElement = document.getElementById('verification-status');

      const interval = setInterval(async () => {
        try {
          const response = await fetch(`/api/check-verification-status/${token}`);
          const data = await response.json();

          if (data.status === 'success') {
            statusElement.innerHTML = '<p style="color: green;">Login successful! Redirecting...</p>';
            clearInterval(interval);
            setTimeout(() => {
              window.location.href = data.redirect_url;
            }, 1000);
          } else if (data.status === 'failed') {
            statusElement.innerHTML = '<p style="color: red;">Face verification failed. Please try again.</p>';
            clearInterval(interval);
          } else if (data.status === 'expired') {
            statusElement.innerHTML = '<p style="color: red;">Verification token expired. Please try again.</p>';
            clearInterval(interval);
          }
        } catch (error) {
          console.error('Error checking status:', error);
        }
      }, 2000);
    }
  </script>
  {% endblock %}